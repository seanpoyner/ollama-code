FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update && apt-get install -y \
    python3.11 python3.11-venv python3-pip \
    git curl wget sudo nano vim \
    fish zsh fontconfig locales \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Setup locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8

# Set Python 3.11 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

# Install Ollama
RUN curl -fsSL https://ollama.ai/install.sh | sh || true

# Ensure ollama user exists with proper setup
RUN useradd -m -s /bin/bash ollama 2>/dev/null || true && \
    echo "ollama ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install oh-my-posh
RUN wget https://github.com/JanDeDobbeleer/oh-my-posh/releases/latest/download/posh-linux-amd64 -O /usr/local/bin/oh-my-posh && \
    chmod +x /usr/local/bin/oh-my-posh

# Create directories before switching user
RUN mkdir -p /home/ollama/.ollama/logs /home/ollama/workspace && \
    chown -R ollama:ollama /home/ollama

USER ollama
WORKDIR /home/ollama

# Configure shells with atomic theme
RUN echo 'eval "$(oh-my-posh init bash --config https://raw.githubusercontent.com/JanDeDobbeleer/oh-my-posh/main/themes/atomic.omp.json)"' >> ~/.bashrc && \
    echo 'alias ll="ls -la"' >> ~/.bashrc && \
    echo 'alias oc="cd /home/ollama/ollama-code && source venv/bin/activate && python -m ollama_code.cli"' >> ~/.bashrc

# Clone and setup ollama-code (use ADD to force fresh clone)
# The date comment forces Docker to not use cache for this layer
ADD https://api.github.com/repos/seanpoyner/ollama-code/git/refs/heads/main version.json
RUN git clone https://github.com/seanpoyner/ollama-code.git && \
    cd ollama-code && \
    python3 -m venv venv && \
    . venv/bin/activate && \
    pip install --upgrade pip && \
    pip install -e .

# Create simple launcher
RUN echo '#!/bin/bash\ncd /home/ollama/ollama-code\nsource venv/bin/activate\nexport PYTHONPATH=/home/ollama/ollama-code:$PYTHONPATH\npython -m ollama_code.cli "$@"' > ~/ollama-code.sh && \
    chmod +x ~/ollama-code.sh && \
    sudo ln -sf /home/ollama/ollama-code.sh /usr/local/bin/ollama-code

# Startup script
RUN echo '#!/bin/bash\necho "🐳 Ollama Code Docker Environment (Atomic Theme)"\necho ""\nollama serve > ~/.ollama/logs/ollama.log 2>&1 &\nsleep 2\necho "Commands:"\necho "  ollama pull llama3.2:3b"\necho "  ollama-code"\necho ""\ntail -f /dev/null' > ~/start.sh && \
    chmod +x ~/start.sh

WORKDIR /home/ollama/workspace
ENTRYPOINT ["/home/ollama/start.sh"]